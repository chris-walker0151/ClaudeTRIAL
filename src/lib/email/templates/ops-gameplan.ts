import type { OpsGameplanEmailData, OpsGameplanTrip } from "../types";
import { APP_URL } from "../constants";

function formatTimestamp(iso: string | null): string {
    if (!iso) return "—";
    try {
        const d = new Date(iso);
        return d.toLocaleDateString("en-US", { weekday: "short", month: "short", day: "numeric" })
            + " at " + d.toLocaleTimeString("en-US", { hour: "numeric", minute: "2-digit", hour12: true });
    } catch {
        return iso;
    }
}

function escapeHtml(str: string): string {
    return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
}

function buildTripRow(trip: OpsGameplanTrip): string {
    const personnelList = trip.personnel.map((p) => `${escapeHtml(p.name)} (${escapeHtml(p.role)})`).join(", ");
    const stopsList = trip.stops.map((s) => {
        const loc = [s.venueName, s.city, s.state].filter(Boolean).map((v) => escapeHtml(v as string)).join(", ");
        const time = s.arrivalTime ? formatTimestamp(s.arrivalTime) : "";
        const action = s.action ? escapeHtml(s.action) : "";
        return `<span style="display:block;margin-bottom:2px;">${loc}${action ? ` — ${action}` : ""}${time ? ` (${time})` : ""}</span>`;
    }).join("");
    const miles = trip.totalMiles != null ? trip.totalMiles.toLocaleString() : "—";
    const hours = trip.totalDriveHrs != null ? trip.totalDriveHrs.toFixed(1) : "—";
    return `<tr><td style="padding:10px 8px;font-size:13px;vertical-align:top;border-bottom:1px solid #e0e0e0;">${escapeHtml(trip.vehicleName)}</td><td style="padding:10px 8px;font-size:13px;vertical-align:top;border-bottom:1px solid #e0e0e0;">${escapeHtml(trip.hubName)}</td><td style="padding:10px 8px;font-size:13px;vertical-align:top;border-bottom:1px solid #e0e0e0;"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:#e8f0fe;color:#1a73e8;font-weight:600;font-size:12px;">${escapeHtml(trip.status)}</span></td><td style="padding:10px 8px;font-size:13px;vertical-align:top;text-align:right;border-bottom:1px solid #e0e0e0;">${miles}</td><td style="padding:10px 8px;font-size:13px;vertical-align:top;text-align:right;border-bottom:1px solid #e0e0e0;">${hours}</td><td style="padding:10px 8px;font-size:13px;vertical-align:top;border-bottom:1px solid #e0e0e0;">${personnelList || "—"}</td><td style="padding:10px 8px;font-size:13px;vertical-align:top;border-bottom:1px solid #e0e0e0;">${stopsList || "—"}</td></tr>`;
}

export function buildOpsGameplanHtml(data: OpsGameplanEmailData): string {
    const alertsSection = data.alerts.length > 0 ? `<table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin-bottom:24px;"><tr><td style="background:#fde8e8;border-left:4px solid #d32f2f;padding:16px;border-radius:4px;"><p style="margin:0 0 8px 0;font-weight:700;color:#d32f2f;font-size:14px;font-family:Arial,Helvetica,sans-serif;">Alerts</p>${data.alerts.map((a) => `<p style="margin:0 0 4px 0;font-size:13px;color:#b71c1c;font-family:Arial,Helvetica,sans-serif;">&bull; ${escapeHtml(a)}</p>`).join("")}</td></tr></table>` : "";
    const thursdaySection = data.thursdayPriorityFlags.length > 0 ? `<table width="100%" cellpadding="0" cellspacing="0" border="0" style="margin-bottom:24px;"><tr><td style="background:#fff8e1;border-left:4px solid #f9a825;padding:16px;border-radius:4px;"><p style="margin:0 0 8px 0;font-weight:700;color:#f57f17;font-size:14px;font-family:Arial,Helvetica,sans-serif;">Thursday Priority Flags</p>${data.thursdayPriorityFlags.map((f) => `<p style="margin:0 0 4px 0;font-size:13px;color:#e65100;font-family:Arial,Helvetica,sans-serif;">&bull; ${escapeHtml(f)}</p>`).join("")}</td></tr></table>` : "";
    const tripRows = data.trips.map(buildTripRow).join("");
    return `<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>Week ${data.weekNumber} Gameplan</title></head><body style="margin:0;padding:0;background:#f4f5f7;font-family:Arial,Helvetica,sans-serif;"><table width="100%" cellpadding="0" cellspacing="0" border="0" style="background:#f4f5f7;"><tr><td align="center" style="padding:24px 16px;"><table width="680" cellpadding="0" cellspacing="0" border="0" style="background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.08);"><tr><td style="background:#1e3a5f;padding:24px 32px;"><h1 style="margin:0;color:#fff;font-size:22px;font-weight:700;font-family:Arial,Helvetica,sans-serif;">Dragon Seats &mdash; Week ${data.weekNumber} Gameplan</h1><p style="margin:6px 0 0 0;color:#b0c4de;font-size:13px;font-family:Arial,Helvetica,sans-serif;">${data.seasonYear} Season</p></td></tr><tr><td style="padding:24px 32px 0 32px;"><table width="100%" cellpadding="0" cellspacing="0" border="0"><tr><td width="33%" style="padding-right:8px;"><table width="100%"><tr><td style="background:#f0f2f5;border-radius:6px;padding:16px;text-align:center;"><p style="margin:0;font-size:28px;font-weight:700;color:#1e3a5f;">${data.totalTrips}</p><p style="margin:4px 0 0 0;font-size:12px;color:#6b7280;text-transform:uppercase;">Total Trips</p></td></tr></table></td><td width="33%" style="padding:0 4px;"><table width="100%"><tr><td style="background:#f0f2f5;border-radius:6px;padding:16px;text-align:center;"><p style="margin:0;font-size:28px;font-weight:700;color:#1e3a5f;">${data.totalPersonnel}</p><p style="margin:4px 0 0 0;font-size:12px;color:#6b7280;text-transform:uppercase;">Total Personnel</p></td></tr></table></td><td width="33%" style="padding-left:8px;"><table width="100%"><tr><td style="background:#f0f2f5;border-radius:6px;padding:16px;text-align:center;"><p style="margin:0;font-size:28px;font-weight:700;color:#1e3a5f;">${data.totalAssets}</p><p style="margin:4px 0 0 0;font-size:12px;color:#6b7280;text-transform:uppercase;">Total Assets</p></td></tr></table></td></tr></table></td></tr><tr><td style="padding:24px 32px 0 32px;">${alertsSection}${thursdaySection}</td></tr><tr><td style="padding:8px 32px 24px 32px;"><h2 style="margin:0 0 12px 0;font-size:16px;color:#1e3a5f;font-weight:700;">Trip Details</h2><table width="100%" cellpadding="0" cellspacing="0" border="0" style="border:1px solid #e0e0e0;border-collapse:collapse;"><thead><tr style="background:#f8f9fb;"><th style="padding:10px 8px;font-size:12px;color:#6b7280;text-transform:uppercase;text-align:left;font-weight:600;border-bottom:2px solid #e0e0e0;">Vehicle</th><th style="padding:10px 8px;font-size:12px;color:#6b7280;text-transform:uppercase;text-align:left;font-weight:600;border-bottom:2px solid #e0e0e0;">Hub</th><th style="padding:10px 8px;font-size:12px;color:#6b7280;text-transform:uppercase;text-align:left;font-weight:600;border-bottom:2px solid #e0e0e0;">Status</th><th style="padding:10px 8px;font-size:12px;color:#6b7280;text-transform:uppercase;text-align:right;font-weight:600;border-bottom:2px solid #e0e0e0;">Miles</th><th style="padding:10px 8px;font-size:12px;color:#6b7280;text-transform:uppercase;text-align:right;font-weight:600;border-bottom:2px solid #e0e0e0;">Hours</th><th style="padding:10px 8px;font-size:12px;color:#6b7280;text-transform:uppercase;text-align:left;font-weight:600;border-bottom:2px solid #e0e0e0;">Personnel</th><th style="padding:10px 8px;font-size:12px;color:#6b7280;text-transform:uppercase;text-align:left;font-weight:600;border-bottom:2px solid #e0e0e0;">Stops</th></tr></thead><tbody>${tripRows || '<tr><td colspan="7" style="padding:24px;text-align:center;color:#9ca3af;">No trips scheduled.</td></tr>'}</tbody></table></td></tr><tr><td style="background:#f8f9fb;padding:20px 32px;border-top:1px solid #e0e0e0;"><p style="margin:0 0 4px 0;font-size:12px;color:#9ca3af;">Generated: ${escapeHtml(data.generatedAt)}</p><p style="margin:0;font-size:12px;"><a href="${APP_URL}" style="color:#1a73e8;text-decoration:none;">Open Dragon Seats Control Tower</a></p></td></tr></table></td></tr></table></body></html>`;
}
